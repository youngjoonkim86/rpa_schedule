# 반복 스케줄 등록 동작 설명

## 반복 스케줄이 계속 등록되는 것이 정상인가요?

### ✅ 정상 동작

**반복 스케줄은 각 실행 시간마다 별도로 등록됩니다.**

예시:
- **반복 스케줄**: 매일 09:00 실행
- **조회 기간**: 2026-01-15 ~ 2026-01-20

**등록되는 스케줄:**
1. 2026-01-15 09:00 (새로 등록)
2. 2026-01-16 09:00 (새로 등록)
3. 2026-01-17 09:00 (새로 등록)
4. 2026-01-18 09:00 (새로 등록)
5. 2026-01-19 09:00 (새로 등록)
6. 2026-01-20 09:00 (새로 등록)

→ **각각 다른 시간이므로 모두 정상적으로 등록됩니다.**

### ❌ 문제 동작

**동일한 시간에 여러 번 등록되는 경우는 문제입니다.**

예시:
- 2026-01-15 09:00이 여러 번 등록됨
- 동일한 스케줄이 중복으로 등록됨

→ **이 경우는 중복 체크 로직으로 방지됩니다.**

## 현재 중복 체크 로직

### 1단계: 정확한 시간 일치 체크
```
bot_id + start_datetime + end_datetime
```
- 동일한 BOT이 동일한 시작/종료 시간에 실행되는 스케줄은 중복으로 간주
- 중복 발견 시 기존 레코드 업데이트

### 2단계: 프로세스 기반 체크
```
process_id + bot_id + start_datetime
```
- 동일한 프로세스, 동일한 BOT, 동일한 시작 시간이면 중복으로 간주
- 중복 발견 시 기존 레코드 업데이트

## 반복 스케줄 처리 방식

### Brity RPA API 응답
```json
{
  "recurringId": "RS_0320ebbca03b4b9a8d52d848f78cf6e6",
  "scheduledTime": "2026-01-15T09:00:00Z",  // 오늘 조회 시
  "processId": "ed0df4f6-30b3-4657-aaa1-99f2c2120674",
  "botName": "ALL"
}
```

**내일 조회 시:**
```json
{
  "recurringId": "RS_0320ebbca03b4b9a8d52d848f78cf6e6",  // 동일
  "scheduledTime": "2026-01-16T09:00:00Z",  // 다른 시간
  "processId": "ed0df4f6-30b3-4657-aaa1-99f2c2120674",  // 동일
  "botName": "ALL"  // 동일
}
```

### 처리 결과

- **2026-01-15 09:00**: 새로 등록 (처음)
- **2026-01-16 09:00**: 새로 등록 (시간이 다르므로)
- **2026-01-15 09:00** (다시 조회 시): 업데이트 (중복 체크로 감지)

## 확인 방법

### DB에서 중복 확인

```sql
-- 동일한 시간에 여러 번 등록된 스케줄 확인
SELECT bot_id, start_datetime, end_datetime, COUNT(*) as count
FROM bot_schedules
WHERE status = 'ACTIVE'
GROUP BY bot_id, start_datetime, end_datetime
HAVING count > 1;
```

**결과가 없으면 정상** (중복 없음)

### 반복 스케줄 확인

```sql
-- 동일한 프로세스의 반복 스케줄 확인
SELECT process_id, bot_id, start_datetime, COUNT(*) as count
FROM bot_schedules
WHERE status = 'ACTIVE'
  AND process_id IS NOT NULL
GROUP BY process_id, bot_id, start_datetime
HAVING count > 1;
```

**결과가 없으면 정상** (동일 시간 중복 없음)

## 요약

| 상황 | 동작 | 정상 여부 |
|------|------|----------|
| 반복 스케줄이 각각 다른 시간에 등록 | 각각 등록 | ✅ 정상 |
| 동일한 시간에 여러 번 등록 시도 | 중복 체크로 업데이트 | ✅ 정상 |
| 동일한 시간에 여러 개가 등록됨 | 문제 | ❌ 비정상 |

**결론**: 반복 스케줄이 각각 다른 시간에 등록되는 것은 **정상 동작**입니다. 동일한 시간에 중복 등록되는 것만 문제이며, 현재 로직으로 방지됩니다.

