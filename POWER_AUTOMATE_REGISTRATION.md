# Power Automate 일정 등록 동작 설명

## 반복 스케줄 등록 방식

### 현재 동작

**반복 스케줄은 각 실행 시간마다 Power Automate에 개별 일정으로 등록됩니다.**

예시:
- **반복 스케줄**: 매일 09:00 실행
- **조회 기간**: 2026-01-15 ~ 2026-01-20

**Power Automate 등록 결과:**
1. 2026-01-15 09:00 → 개별 일정으로 등록
2. 2026-01-16 09:00 → 개별 일정으로 등록
3. 2026-01-17 09:00 → 개별 일정으로 등록
4. 2026-01-18 09:00 → 개별 일정으로 등록
5. 2026-01-19 09:00 → 개별 일정으로 등록
6. 2026-01-20 09:00 → 개별 일정으로 등록

### 이유

Power Automate API가 반복 일정(Recurring Event)을 지원하지 않으므로, 각 실행 시간을 개별 일정으로 등록해야 합니다.

## 중복 방지 로직

### 1. Power Automate 중복 체크

각 스케줄 등록 전에:
1. Power Automate에서 해당 시간 범위의 일정 조회
2. 동일한 BOT과 시간대의 일정이 있는지 확인
3. 있으면 등록하지 않음 (건너뜀)

**체크 조건:**
- BOT 이름 일치 (`botName` 또는 `botId`)
- 시간 겹침 또는 5분 이내 차이

### 2. DB 중복 체크

`Schedule.upsert()` 메서드에서:
- `bot_id` + `start_datetime` + `end_datetime` 조합으로 중복 체크
- `process_id` + `bot_id` + `start_datetime` 조합으로 추가 체크

## 등록 흐름

```
1. Brity RPA에서 스케줄 조회
   ↓
2. 각 스케줄에 대해:
   a. Power Automate에서 일정 조회 (시간 범위: ±1시간)
   b. 중복 체크 (BOT 이름 + 시간)
   c. 없으면 Power Automate에 등록
   d. DB에 저장 (중복 체크 포함)
   ↓
3. 완료
```

## 로그 확인

서버 콘솔에서 다음 로그를 확인할 수 있습니다:

```
✅ 일정 등록: ALL - 외부연계 테스트 수정
⏭️ 일정 건너뜀 (이미 존재): ALL - 외부연계 테스트
✅ 일정 등록: ALL - searchphone
```

## 요약

| 질문 | 답변 |
|------|------|
| 반복 스케줄이 매번 등록되나요? | ✅ 네, 각 실행 시간마다 개별 일정으로 등록됩니다. |
| 동일한 시간에 중복 등록되나요? | ❌ 아니요, 중복 체크로 방지됩니다. |
| Power Automate에서 반복 일정으로 등록되나요? | ❌ 아니요, 개별 일정으로 등록됩니다. (API 제한) |

**결론**: 반복 스케줄은 각 실행 시간마다 Power Automate에 개별 일정으로 등록되는 것이 정상 동작입니다. 동일한 시간에 중복 등록되는 것은 중복 체크 로직으로 방지됩니다.

